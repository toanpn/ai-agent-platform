<div class="agent-form-container">
	<div class="header">
		<h1>{{ isEditMode ? ('AGENTS.EDIT_AGENT' | translate) : ('AGENTS.CREATE_NEW_AGENT' | translate) }}</h1>
	</div>

	<div class="loading-indicator" *ngIf="loading">
		<p>{{ isEditMode ? ('AGENTS.LOADING_AGENT' | translate) : ('AGENTS.CREATING_AGENT' | translate) }}</p>
	</div>

	<div class="error-message" *ngIf="saveError">
		<p>{{ saveError | translate }}</p>
	</div>

	<form [formGroup]="agentForm" (ngSubmit)="onSubmit()" *ngIf="!loading || isEditMode">
		<div class="form-group">
			<label for="name">{{ 'AGENTS.AGENT_NAME' | translate }}</label>
			<input type="text" id="name" formControlName="name" [placeholder]="'AGENTS.ENTER_AGENT_NAME' | translate" />
			<div
				class="validation-error"
				*ngIf="agentForm.get('name')?.invalid && agentForm.get('name')?.touched"
			>
				<p *ngIf="agentForm.get('name')?.errors?.['required']">{{ 'AGENTS.NAME_REQUIRED' | translate }}</p>
				<p *ngIf="agentForm.get('name')?.errors?.['minlength']">
					{{ 'AGENTS.NAME_MIN_LENGTH' | translate }}
				</p>
				<p *ngIf="agentForm.get('name')?.errors?.['maxlength']">
					{{ 'AGENTS.NAME_MAX_LENGTH' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<label for="department">{{ 'AGENTS.DEPARTMENT' | translate }}</label>
			<mat-form-field appearance="outline" class="full-width">
				<mat-select
					id="department"
					formControlName="department"
					[placeholder]="'AGENTS.SELECT_DEPARTMENT' | translate"
				>
					<mat-option *ngFor="let department of departments" [value]="department">
						{{ department }}
					</mat-option>
				</mat-select>
			</mat-form-field>
			<div
				class="validation-error"
				*ngIf="agentForm.get('department')?.invalid && agentForm.get('department')?.touched"
			>
				<p *ngIf="agentForm.get('department')?.errors?.['required']">
					{{ 'AGENTS.DEPARTMENT_REQUIRED' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<div class="tools-section-header">
				<label for="tools">{{ 'AGENTS.TOOLS' | translate }}</label>
				<span class="tools-count" *ngIf="tools.length > 0">
					({{ toolConfigs.length }}/{{ tools.length }} {{ 'AGENTS.CONNECTED' | translate | lowercase }})
				</span>
			</div>
			<div class="tools-description">
				<p>{{ 'AGENTS.TOOLS_HELP' | translate }}</p>
			</div>

			<div class="tools-container">
				<!-- Loading State -->
				<div *ngIf="loadingTools" class="loading-tools-indicator">
					<mat-spinner diameter="40"></mat-spinner>
					<p>{{ 'AGENTS.LOADING_TOOLS' | translate }}</p>
				</div>

				<!-- Error State -->
				<div *ngIf="toolsError && !loadingTools" class="error-message">
					<mat-icon>error_outline</mat-icon>
					<p>{{ toolsError | translate }}</p>
					<button mat-stroked-button (click)="loadTools()" class="retry-button">
						{{ 'COMMON.RETRY' | translate }}
					</button>
				</div>

				<!-- Empty State -->
				<div *ngIf="!loadingTools && !toolsError && tools.length === 0" class="empty-tools-state">
					<mat-icon class="empty-icon">extension</mat-icon>
					<h3>{{ 'AGENTS.NO_TOOLS_AVAILABLE' | translate }}</h3>
					<p>{{ 'AGENTS.NO_TOOLS_DESCRIPTION' | translate }}</p>
				</div>

				<!-- Tools Grid -->
				<div class="tools-grid" *ngIf="!loadingTools && !toolsError && tools.length > 0">
					<div
						*ngFor="let tool of tools; trackBy: trackByToolId"
						class="tool-card"
						[class.connected]="isToolConnected(tool.id)"
						[class.has-config]="hasRequiredConfig(tool)"
						tabindex="0"
						role="button"
						[attr.aria-pressed]="isToolConnected(tool.id)"
						[attr.aria-label]="getToolCardAriaLabel(tool)"
						(click)="toggleToolConnection(tool)"
						(keydown.enter)="toggleToolConnection(tool)"
						(keydown.space)="$event.preventDefault(); toggleToolConnection(tool)"
					>
						<div class="tool-card-header">
							<div class="tool-info">
								<h3 class="tool-name">{{ tool.name }}</h3>
								<span class="tool-type" *ngIf="tool.file">
									{{ getToolTypeFromFile(tool.file) }}
								</span>
							</div>
							<div class="connection-status" *ngIf="isToolConnected(tool.id)">
								<div class="status-indicator">
									<div class="status-dot"></div>
									<span class="status-text">{{ 'AGENTS.CONNECTED' | translate }}</span>
								</div>
							</div>
						</div>

						<div class="tool-content">
							<p class="tool-description" [title]="tool.description">
								{{ tool.description }}
							</p>

							<div class="tool-requirements" *ngIf="hasRequiredConfig(tool)">
								<mat-icon class="config-icon">settings</mat-icon>
								<span class="config-text">{{ 'AGENTS.REQUIRES_CONFIGURATION' | translate }}</span>
							</div>
						</div>

						<div class="tool-card-footer">
							<button
								type="button"
								mat-stroked-button
								[color]="isToolConnected(tool.id) ? 'accent' : 'primary'"
								class="connection-button"
								[attr.aria-label]="getConnectionButtonAriaLabel(tool)"
							>
								<mat-icon>{{ isToolConnected(tool.id) ? 'link_off' : 'link' }}</mat-icon>
								{{ (isToolConnected(tool.id) ? 'AGENTS.DISCONNECT' : 'AGENTS.CONNECT') | translate }}
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="llm-config-section" formGroupName="llmConfig">
			<h2>{{ 'AGENTS.LLM.TITLE' | translate }}</h2>
			<div class="form-group">
				<label for="llmModel">{{ 'AGENTS.LLM.MODEL' | translate }}</label>
				<mat-form-field appearance="outline" class="full-width">
					<mat-select id="llmModel" formControlName="modelName">
						<mat-option *ngFor="let model of llmModels" [value]="model">
							{{ model }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			</div>

			<div class="form-group">
				<label for="temperature">{{ 'AGENTS.LLM.TEMPERATURE' | translate }}</label>
				<mat-slider
					min="0"
					max="1"
					step="0.1"
					discrete
					thumbLabel
					class="full-width"
				>
					<input matSliderThumb formControlName="temperature" />
				</mat-slider>
				<div class="helper-text" *ngIf="agentForm.get('llmConfig.temperature')?.value !== null">
					<p>{{ getTemperatureTooltip(agentForm.get('llmConfig.temperature')?.value) | translate }}</p>
				</div>
			</div>
		</div>

		<div class="form-group">
			<div class="field-header">
				<label for="description">{{ 'AGENTS.AGENT_DESCRIPTION' | translate }} ({{ 'AGENTS.OPTIONAL' | translate }})</label>
				<button
					type="button"
					mat-icon-button
					color="accent"
					class="enhance-button"
					[disabled]="!agentForm.get('description')?.value?.trim() || isEnhancingDescription"
					(click)="enhanceDescription()"
					[matTooltip]="'AGENTS.ENHANCE_DESCRIPTION' | translate"
					[attr.aria-label]="'AGENTS.ENHANCE_DESCRIPTION' | translate"
				>
					<mat-spinner *ngIf="isEnhancingDescription" diameter="20" aria-hidden="true"></mat-spinner>
					<mat-icon *ngIf="!isEnhancingDescription" aria-hidden="true">auto_fix_high</mat-icon>
				</button>
			</div>
			<textarea
				id="description"
				formControlName="description"
				[placeholder]="'AGENTS.DESCRIBE_AGENT' | translate"
				rows="4"
			></textarea>
			<div
				class="validation-error"
				*ngIf="
					agentForm.get('description')?.invalid && agentForm.get('description')?.touched
				"
			>
				<p *ngIf="agentForm.get('description')?.errors?.['maxlength']">
					{{ 'AGENTS.DESCRIPTION_MAX_LENGTH' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<div class="field-header">
				<label for="instructions">{{ 'AGENTS.INSTRUCTIONS' | translate }} ({{ 'AGENTS.OPTIONAL' | translate }})</label>
				<button
					type="button"
					mat-icon-button
					color="accent"
					class="enhance-button"
					[disabled]="!agentForm.get('instructions')?.value?.trim() || isEnhancingInstruction"
					(click)="enhanceInstruction()"
					[matTooltip]="'AGENTS.ENHANCE_INSTRUCTION' | translate"
					[attr.aria-label]="'AGENTS.ENHANCE_INSTRUCTION' | translate"
				>
					<mat-spinner *ngIf="isEnhancingInstruction" diameter="20" aria-hidden="true"></mat-spinner>
					<mat-icon *ngIf="!isEnhancingInstruction" aria-hidden="true">auto_fix_high</mat-icon>
				</button>
			</div>
			<textarea
				id="instructions"
				formControlName="instructions"
				[placeholder]="'AGENTS.ENTER_INSTRUCTIONS' | translate"
				rows="6"
			></textarea>
			<div
				class="validation-error"
				*ngIf="
					agentForm.get('instructions')?.invalid && agentForm.get('instructions')?.touched
				"
			>
				<p *ngIf="agentForm.get('instructions')?.errors?.['maxlength']">
					{{ 'AGENTS.INSTRUCTIONS_MAX_LENGTH' | translate }}
				</p>
			</div>
			<div class="helper-text">
				<p>{{ 'AGENTS.INSTRUCTIONS_HELP' | translate }}</p>
			</div>
		</div>

		<!-- Agent Files Section -->
		<div class="files-section" *ngIf="isEditMode">
			<h2>{{ 'AGENTS.FILES.TITLE' | translate }}</h2>
			<div class="file-upload-area">
				<input
					type="file"
					(change)="onFileSelected($event)"
					#fileInput
					style="display: none"
					id="file-upload-input"
				/>
				<button *ngIf="!selectedFile" type="button" mat-stroked-button color="primary" (click)="fileInput.click()">
					<mat-icon>attach_file</mat-icon>
					{{ 'AGENTS.FILES.SELECT_FILE' | translate }}
				</button>
			</div>
			<!-- Display for the newly selected file -->
			<div *ngIf="selectedFile" class="selected-file-display">
				<mat-icon class="file-icon">insert_drive_file</mat-icon>
				<span class="file-name" [title]="selectedFile.name">{{ selectedFile.name }}</span>
				<span class="file-size">({{ selectedFile.size | number }} bytes)</span>
				<button
					mat-icon-button
					color="warn"
					type="button"
					(click)="removeSelectedFile(fileInput)"
					[matTooltip]="'AGENTS.FILES.REMOVE_SELECTED' | translate"
					[attr.aria-label]="'AGENTS.FILES.REMOVE_SELECTED' | translate"
				>
					<mat-icon>close</mat-icon>
				</button>
			</div>

			<div class="file-list" *ngIf="agentFiles.length > 0">
				<mat-list>
					<mat-list-item *ngFor="let file of agentFiles">
						<mat-icon matListItemIcon>description</mat-icon>
						<div matListItemTitle>{{ file.fileName }}</div>
						<div matListItemLine>{{ file.fileSize | number }} bytes</div>
						<button
							mat-icon-button
							color="warn"
							type="button"
							(click)="deleteFile(file.id)"
							[matTooltip]="'AGENTS.FILES.DELETE' | translate"
						>
							<mat-icon>delete</mat-icon>
						</button>
					</mat-list-item>
				</mat-list>
			</div>
			<div class="empty-state" *ngIf="agentFiles.length === 0 && !selectedFile">
				<p>{{ 'AGENTS.FILES.NO_FILES' | translate }}</p>
			</div>
		</div>

		<div class="form-actions">
			<button type="button" class="cancel-button" (click)="cancel()">{{ 'COMMON.CANCEL' | translate }}</button>
			<button type="submit" class="save-button" [disabled]="agentForm.invalid || loading">
				{{ isEditMode ? ('AGENTS.SAVE_CHANGES' | translate) : ('AGENTS.CREATE_AGENT' | translate) }}
			</button>
		</div>
	</form>
</div>
