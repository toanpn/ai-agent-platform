<div class="agent-form-container">
	<div class="header">
		<h1>{{ isEditMode ? ('AGENTS.EDIT_AGENT' | translate) : ('AGENTS.CREATE_NEW_AGENT' | translate) }}</h1>
	</div>

	<div class="loading-indicator" *ngIf="loading">
		<p>{{ isEditMode ? ('AGENTS.LOADING_AGENT' | translate) : ('AGENTS.CREATING_AGENT' | translate) }}</p>
	</div>

	<div class="error-message" *ngIf="saveError">
		<p>{{ saveError | translate }}</p>
	</div>

	<form [formGroup]="agentForm" (ngSubmit)="onSubmit()" *ngIf="!loading || isEditMode">
		<div class="form-group">
			<label for="name">{{ 'AGENTS.AGENT_NAME' | translate }}</label>
			<input type="text" id="name" formControlName="name" [placeholder]="'AGENTS.ENTER_AGENT_NAME' | translate" />
			<div
				class="validation-error"
				*ngIf="agentForm.get('name')?.invalid && agentForm.get('name')?.touched"
			>
				<p *ngIf="agentForm.get('name')?.errors?.['required']">{{ 'AGENTS.NAME_REQUIRED' | translate }}</p>
				<p *ngIf="agentForm.get('name')?.errors?.['minlength']">
					{{ 'AGENTS.NAME_MIN_LENGTH' | translate }}
				</p>
				<p *ngIf="agentForm.get('name')?.errors?.['maxlength']">
					{{ 'AGENTS.NAME_MAX_LENGTH' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<label for="department">{{ 'AGENTS.DEPARTMENT' | translate }}</label>
			<mat-form-field appearance="outline" class="full-width">
				<mat-select
					id="department"
					formControlName="department"
					[placeholder]="'AGENTS.SELECT_DEPARTMENT' | translate"
				>
					<mat-option *ngFor="let department of departments" [value]="department">
						{{ department }}
					</mat-option>
				</mat-select>
			</mat-form-field>
			<div
				class="validation-error"
				*ngIf="agentForm.get('department')?.invalid && agentForm.get('department')?.touched"
			>
				<p *ngIf="agentForm.get('department')?.errors?.['required']">
					{{ 'AGENTS.DEPARTMENT_REQUIRED' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<label for="tools">{{ 'AGENTS.TOOLS' | translate }} ({{ 'AGENTS.OPTIONAL' | translate }})</label>
			<mat-form-field appearance="outline" class="full-width">
				<mat-select 
					formControlName="tools" 
					multiple 
					[placeholder]="'AGENTS.SELECT_TOOLS' | translate"
					(focus)="loadTools()"
				>
					<mat-option *ngFor="let tool of tools" [value]="tool.name">
						{{ tool.name }}
						<span *ngIf="tool.description" class="tool-description"> - {{ tool.description }}</span>
					</mat-option>
				</mat-select>
				<mat-spinner *ngIf="loadingTools" matSuffix diameter="20"></mat-spinner>
			</mat-form-field>
			<div class="error-message" *ngIf="toolsError">
				<p>{{ toolsError | translate }}</p>
			</div>
			<div class="helper-text">
				<p>{{ 'AGENTS.TOOLS_HELP' | translate }}</p>
			</div>
		</div>

		<div class="llm-config-section" formGroupName="llmConfig">
			<h2>{{ 'AGENTS.LLM.TITLE' | translate }}</h2>
			<div class="form-group">
				<label for="llmModel">{{ 'AGENTS.LLM.MODEL' | translate }}</label>
				<mat-form-field appearance="outline" class="full-width">
					<mat-select id="llmModel" formControlName="modelName">
						<mat-option *ngFor="let model of llmModels" [value]="model">
							{{ model }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			</div>

			<div class="form-group">
				<label for="temperature">{{ 'AGENTS.LLM.TEMPERATURE' | translate }}</label>
				<mat-slider
					min="0"
					max="1"
					step="0.1"
					discrete
					thumbLabel
					class="full-width"
				>
					<input matSliderThumb formControlName="temperature" />
				</mat-slider>
				<div class="helper-text" *ngIf="agentForm.get('llmConfig.temperature')?.value !== null">
					<p>{{ getTemperatureTooltip(agentForm.get('llmConfig.temperature')?.value) | translate }}</p>
				</div>
			</div>
		</div>

		<div class="form-group">
			<div class="field-header">
				<label for="description">{{ 'AGENTS.AGENT_DESCRIPTION' | translate }} ({{ 'AGENTS.OPTIONAL' | translate }})</label>
				<button
					type="button"
					mat-icon-button
					color="accent"
					class="enhance-button"
					[disabled]="!agentForm.get('description')?.value?.trim() || isEnhancingDescription"
					(click)="enhanceDescription()"
					[matTooltip]="'AGENTS.ENHANCE_DESCRIPTION' | translate"
					[attr.aria-label]="'AGENTS.ENHANCE_DESCRIPTION' | translate"
				>
					<mat-spinner *ngIf="isEnhancingDescription" diameter="20" aria-hidden="true"></mat-spinner>
					<mat-icon *ngIf="!isEnhancingDescription" aria-hidden="true">auto_fix_high</mat-icon>
				</button>
			</div>
			<textarea
				id="description"
				formControlName="description"
				[placeholder]="'AGENTS.DESCRIBE_AGENT' | translate"
				rows="4"
				[disabled]="isEnhancingDescription"
			></textarea>
			<div
				class="validation-error"
				*ngIf="
					agentForm.get('description')?.invalid && agentForm.get('description')?.touched
				"
			>
				<p *ngIf="agentForm.get('description')?.errors?.['maxlength']">
					{{ 'AGENTS.DESCRIPTION_MAX_LENGTH' | translate }}
				</p>
			</div>
		</div>

		<div class="form-group">
			<label for="instructions">{{ 'AGENTS.INSTRUCTIONS' | translate }} ({{ 'AGENTS.OPTIONAL' | translate }})</label>
			<textarea
				id="instructions"
				formControlName="instructions"
				[placeholder]="'AGENTS.ENTER_INSTRUCTIONS' | translate"
				rows="6"
			></textarea>
			<div
				class="validation-error"
				*ngIf="
					agentForm.get('instructions')?.invalid && agentForm.get('instructions')?.touched
				"
			>
				<p *ngIf="agentForm.get('instructions')?.errors?.['maxlength']">
					{{ 'AGENTS.INSTRUCTIONS_MAX_LENGTH' | translate }}
				</p>
			</div>
			<div class="helper-text">
				<p>{{ 'AGENTS.INSTRUCTIONS_HELP' | translate }}</p>
			</div>
		</div>

		<div class="form-actions">
			<button type="button" class="cancel-button" (click)="cancel()">{{ 'COMMON.CANCEL' | translate }}</button>
			<button type="submit" class="save-button" [disabled]="agentForm.invalid || loading">
				{{ isEditMode ? ('AGENTS.SAVE_CHANGES' | translate) : ('AGENTS.CREATE_AGENT' | translate) }}
			</button>
		</div>
	</form>
</div>
